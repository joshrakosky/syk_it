'use client'

import { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabase'
import * as XLSX from 'xlsx'
import { OrderWithItems } from '@/types'

const ADMIN_EMAIL = 'josh.rakosky@gmail.com'

export default function AdminExportButton() {
  const [isAdmin, setIsAdmin] = useState(false)
  const [loading, setLoading] = useState(false)

  useEffect(() => {
    // Check if current user's email matches admin email
    const email = sessionStorage.getItem('orderEmail')
    setIsAdmin(email?.toLowerCase() === ADMIN_EMAIL.toLowerCase())
  }, [])

  const exportToExcel = async () => {
    if (!isAdmin) return

    try {
      setLoading(true)

      // Fetch all orders with their items
      const { data: ordersData, error: ordersError } = await supabase
        .from('christmas_orders')
        .select('*')
        .order('created_at', { ascending: false })

      if (ordersError) throw ordersError

      // Fetch all products to get deco information
      const { data: productsData, error: productsError } = await supabase
        .from('christmas_products')
        .select('id, deco')

      if (productsError) throw productsError

      // Create a map of product_id -> deco for quick lookup
      const productDecoMap = new Map<string, string>()
      productsData?.forEach(product => {
        if (product.deco) {
          productDecoMap.set(product.id, product.deco)
        }
      })

      // Fetch order items for each order
      const ordersWithItems: OrderWithItems[] = await Promise.all(
        (ordersData || []).map(async (order) => {
          const { data: items, error: itemsError } = await supabase
            .from('christmas_order_items')
            .select('*')
            .eq('order_id', order.id)
            .order('created_at')

          if (itemsError) throw itemsError

          return {
            ...order,
            items: items || []
          }
        })
      )

      // Sheet 1: Detailed Orders (one row per item)
      const detailedData = ordersWithItems.flatMap(order => {
        return order.items.map((item) => ({
          'Order Number': order.order_number,
          'Email': order.email,
          'Product Name': item.product_name,
          'Customer Item #': item.customer_item_number || '',
          'Color': item.color || '',
          'Size': item.size || '',
          'Shipping Name': order.shipping_name,
          'Shipping Address': order.shipping_address,
          'Shipping City': order.shipping_city,
          'Shipping State': order.shipping_state,
          'Shipping ZIP': order.shipping_zip,
          'Shipping Country': order.shipping_country,
          'Order Date': new Date(order.created_at).toLocaleDateString()
        }))
      })

      // Sheet 2: Distribution Summary (grouped by product/color/size)
      const summaryMap = new Map<string, { quantity: number; deco: string }>()
      
      ordersWithItems.forEach(order => {
        order.items.forEach(item => {
          // Create a unique key for product/color/size combination
          const key = [
            item.product_name,
            item.customer_item_number || '',
            item.color || 'N/A',
            item.size || 'N/A'
          ].join('|')
          
          // Get deco from product, with color-specific logic for Sweater Fleece and Tile Mate
          let deco = item.product_id ? (productDecoMap.get(item.product_id) || '') : ''
          
          // Handle color-specific deco for Sweater Fleece products
          if (item.product_name?.includes('Sweater Fleece')) {
            if (item.color === 'Black Heather') {
              deco = 'Stryker | Right Chest | PMS 421 Grey'
            } else if (item.color === 'Medium Grey Heather') {
              deco = 'Stryker | Right Chest | Black'
            }
          }
          
          // Handle color-specific deco for Tile Mate products
          if (item.product_name?.includes('Tile Mate')) {
            if (item.color === 'Black') {
              deco = 'Stryker | Right Corner | PMS 421 Grey'
            } else if (item.color === 'White') {
              deco = 'Stryker | Right Corner | Black'
            }
          }
          
          // Handle color-specific deco for Under Armour Unstoppable jackets
          if (item.product_name?.includes('Unstoppable')) {
            if (item.color === 'Gray' || item.color === 'Grey') {
              deco = 'Stryker | Right Chest | Black'
            } else if (item.color === 'Black') {
              deco = 'Stryker | Right Chest | PMS 421 Grey'
            }
          }
          
          // Handle color-specific deco for Adidas Polos
          if (item.product_name === 'Adidas Men\'s Polo' || item.product_name === 'Adidas Women\'s Polo') {
            if (item.color === 'Grey Three') {
              deco = 'Stryker | Left Chest | Black'
            } else {
              deco = 'Stryker | Left Chest | PMS 421 Grey'
            }
          }
          
          // Handle deco for New Era Caps (all colors get PMS 421 Grey)
          if (item.product_name === 'New Era Cap') {
            deco = 'Stryker | Center of Cap | PMS 421 Grey'
          }
          
          // Handle color-specific deco for North Face Beanies
          if (item.product_name === 'The North Face Beanie') {
            if (item.color === 'TNF Yellow' || item.color === 'TNF Medium Grey Heather') {
              deco = 'Stryker | Center of Beanie Cuff | Black'
            } else {
              deco = 'Stryker | Center of Beanie Cuff | PMS 421 Grey'
            }
          }
          
          // Handle deco for Apple AirTag
          if (item.product_name === 'Apple AirTag') {
            deco = 'Stryker | Center of AirTag | Black'
          }
          
          // Handle deco for Skull Candy Earbuds
          if (item.product_name === 'Skull Candy Earbuds') {
            deco = 'Stryker | Front of Case | PMS 421 Grey'
          }
          
          // Handle deco for Tech Organizer
          if (item.product_name === 'Tech Organizer') {
            deco = 'Stryker | Front Pocket | PMS 421 Grey'
          }
          
          // Handle deco for Power Bank
          if (item.product_name === 'Power Bank') {
            deco = 'Stryker | Front of Power Bank | PMS 421 Grey'
          }
          
          const existing = summaryMap.get(key)
          if (existing) {
            summaryMap.set(key, { quantity: existing.quantity + 1, deco: existing.deco })
          } else {
            summaryMap.set(key, { quantity: 1, deco })
          }
        })
      })

      // Convert map to array for Excel
      const summaryData = Array.from(summaryMap.entries()).map(([key, data]) => {
        const [productName, customerItem, color, size] = key.split('|')
        return {
          'Product Name': productName,
          'Customer Item #': customerItem,
          'Color': color,
          'Size': size,
          'Deco': data.deco || '',
          'Quantity': data.quantity
        }
      }).sort((a, b) => {
        // Sort by product name, then color, then size
        if (a['Product Name'] !== b['Product Name']) {
          return a['Product Name'].localeCompare(b['Product Name'])
        }
        if (a['Color'] !== b['Color']) {
          return a['Color'].localeCompare(b['Color'])
        }
        return a['Size'].localeCompare(b['Size'])
      })

      // Create workbook with two sheets
      const wb = XLSX.utils.book_new()
      
      // Detailed Orders sheet
      const wsDetailed = XLSX.utils.json_to_sheet(detailedData)
      XLSX.utils.book_append_sheet(wb, wsDetailed, 'Detailed Orders')
      
      // Distribution Summary sheet
      const wsSummary = XLSX.utils.json_to_sheet(summaryData)
      XLSX.utils.book_append_sheet(wb, wsSummary, 'Distribution Summary')

      // Generate filename with current date
      const filename = `stryker-orders-${new Date().toISOString().split('T')[0]}.xlsx`

      // Write file
      XLSX.writeFile(wb, filename)
    } catch (error: any) {
      console.error('Export error:', error)
      alert('Failed to export orders. Please try again.')
    } finally {
      setLoading(false)
    }
  }

  if (!isAdmin) return null

  return (
    <button
      onClick={exportToExcel}
      disabled={loading}
      className="fixed top-4 right-4 z-50 px-4 py-2 bg-green-600 text-white rounded-md shadow-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 text-sm font-medium"
      title="Export all orders to Excel (Admin only)"
    >
      {loading ? (
        <>
          <svg className="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Exporting...
        </>
      ) : (
        <>
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Export Orders
        </>
      )}
    </button>
  )
}

